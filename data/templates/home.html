{% extends 'base.html' %}

{% block content %}
<header class="header d-flex justify-content-between align-items-center">
    <h1 class="h3">IoT Security Monitor</h1>
    <button id="scanDevices" class="btn btn-primary">Scan Devices</button>
</header>

<main>
    <section id="deviceList" class="device-list">
        <h2 class="h5">Devices:</h2>
        <ul class="list-group" id="devices-container">
            <!-- Devices will be inserted here -->
        </ul>
    </section>
</main>

<!-- Device Template -->
<template id="device-template">
    <li class="list-group-item">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <a href="" class="device-link"></a>
                <span class="badge badge-dark badge-pill users-display ml-2"></span>
            </div>
            <div>
                <button class="btn btn-sm btn-warning edit-device">Edit</button>
                <button class="btn btn-sm btn-danger delete-device ml-2">Delete</button>
            </div>
        </div>
    </li>
</template>

<!-- Edit Form Template -->
<template id="edit-form-template">
    <div class="edit-form p-3">
        <div class="form-group">
            <label>Name:</label>
            <input type="text" class="form-control" id="edit-name">
        </div>
        <div class="form-group">
            <label>Number of Users:</label>
            <input type="number" class="form-control" id="edit-users" min="1">
        </div>
        <button class="btn btn-primary save-edit">Save</button>
        <button class="btn btn-secondary cancel-edit">Cancel</button>
    </div>
</template>

<!-- No Devices Template -->
<template id="no-devices-template">
    <li class="list-group-item text-center">No devices found.</li>
</template>
{% endblock %}

{% block extra_js %}
<script>
    function loadActiveDevices() {
        console.log('Loading devices...');
        fetch("/", {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
        })
        .then(response => response.json())
        .then(data => {
            console.log('Received data:', data);
            const deviceList = document.getElementById('devices-container');
            deviceList.innerHTML = '';

            if (data.devices && data.devices.length > 0) {
                console.log(`Found ${data.devices.length} devices`);
                data.devices.forEach(function(device) {
                    console.log('Processing device:', device);
                    const template = document.getElementById('device-template');
                    if (!template) {
                        console.error('Template not found!');
                        return;
                    }
                    const clone = template.content.cloneNode(true);
                    
                    // Set device information
                    const link = clone.querySelector('.device-link');
                    link.href = `/packets/${device.ip}/`;
                    link.textContent = device.name || device.ip;

                    // Set number of users
                    clone.querySelector('.users-display').textContent = `Users: ${device.number_of_users}`;

                    // Set button data
                    clone.querySelector('.edit-device').dataset.id = device.id;
                    clone.querySelector('.delete-device').dataset.id = device.id;

                    deviceList.appendChild(clone);
                });
            } else {
                console.log('No devices found');
                const template = document.getElementById('no-devices-template');
                const clone = template.content.cloneNode(true);
                deviceList.appendChild(clone);
            }
        })
        .catch(error => {
            console.error('Error loading devices:', error);
        });
    }

    // Initial load
    $(document).ready(function() {
        loadActiveDevices();
    });

    // Scan button handler
    $('#scanDevices').click(function() {
        $(this).prop('disabled', true).text('Scanning...');
        loadActiveDevices();
        setTimeout(() => {
            $(this).prop('disabled', false).text('Scan Devices');
        }, 2000);
    });

    // Edit device handler
    $(document).on('click', '.edit-device', function() {
        const deviceId = $(this).data('id');
        const listItem = $(this).closest('li');
        const name = listItem.find('.device-name').text() || listItem.find('.device-link').text();
        const users = parseInt(listItem.find('.users-display').text().match(/\d+/)[0]);

        const template = document.getElementById('edit-form-template');
        const clone = document.importNode(template.content, true);

        // Set form values
        clone.querySelector('#edit-name').value = name;
        clone.querySelector('#edit-users').value = users;
        clone.querySelector('.save-edit').dataset.id = deviceId;

        listItem.html(clone);
    });

    // Save edit handler
    $(document).on('click', '.save-edit', function() {
        const deviceId = $(this).data('id');
        const newData = {
            name: $('#edit-name').val().trim(),
            number_of_users: parseInt($('#edit-users').val())
        };
        
        fetch(`/api/devices/${deviceId}/update/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(newData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                loadActiveDevices();  // Refresh the list
            } else {
                alert(data.message || 'Error updating device');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating device');
        });
    });

    // Cancel edit handler
    $(document).on('click', '.cancel-edit', function() {
        loadActiveDevices();  // Refresh the list to cancel edit
    });

    // Delete device handler
    $(document).on('click', '.delete-device', function() {
        const deviceId = $(this).data('id');
        if (confirm('Are you sure you want to delete this device?')) {
            fetch(`/api/devices/${deviceId}/delete/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    loadActiveDevices();  // Refresh the list
                } else {
                    alert('Error deleting device');
                }
            });
        }
    });

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
