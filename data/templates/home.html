{% extends 'base.html' %}

{% block content %}
<header class="header d-flex justify-content-between align-items-center">
    <h1 class="h3">IoT Security Monitor</h1>
</header>
<main>
    <section id="deviceList" class="device-list">
        <h2 class="h5">Active Devices:</h2>
        <ul class="list-group"></ul>
    </section>
</main>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function () {
        // Function to load active devices
        function loadActiveDevices() {
            $.ajax({
                url: '', // Using the same URL as before
                type: 'GET',
                success: function (data) {
                    // Clear the current list
                    $('#deviceList .list-group').empty();

                    if (data.devices && data.devices.length > 0) {
                        data.devices.forEach(function (device) {
                            // Format volume and speed
                            const volumeDisplay = device.volume == 0 ? '--' : device.volume;
                            const speedDisplay = device.speed == 0 ? '--' : device.speed;
                            console.log("updated successfully")
                            $('#deviceList .list-group').append(`
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <a href="/packets/${device.ip}/">${device.ip}</a>
                                    <span>
                                        <span class="badge badge-primary badge-pill">Volume: ${volumeDisplay}</span>
                                        <span class="badge badge-info badge-pill">Speed: ${speedDisplay}</span>
                                    </span>
                                </li>
                            `);
                        });
                    } else {
                        $('#deviceList .list-group').append(
                            '<li class="list-group-item text-center">No active devices found.</li>'
                        );
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error:', error);
                    $('#deviceList .list-group').append(
                        '<li class="list-group-item text-center text-danger">Error retrieving devices.</li>'
                    );
                }
            });
        }

        // Load devices when page loads
        loadActiveDevices();

        // Refresh the device list every 30 seconds
        setInterval(loadActiveDevices, 30000);
    });
</script>
{% endblock %}