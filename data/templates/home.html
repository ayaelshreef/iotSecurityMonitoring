{% extends 'base.html' %}

{% block content %}

<header class="header d-flex justify-content-between align-items-center">
    <h1 class="h3">IoT Security Monitor</h1>
    <button id="scanDevices" class="btn btn-primary">Scan Devices</button>
</header>
<main>
    <section id="deviceList" class="device-list">
        <h2 class="h5">Devices:</h2>
        <ul class="list-group"></ul>
    </section>
</main>
{% endblock %}
{% block extra_js %}
<script>
    // Function to load active devices
    function loadActiveDevices() {
        fetch("/", {  // Include the IP address in the URL
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
        })
            .then(response => response.json())
            .then(data => {                // Clear the current list
                $('#deviceList .list-group').empty();

                if (data.devices && data.devices.length > 0) {
                    data.devices.forEach(function (device) {
                        const statusClass = device.is_active ? 'badge-success' : 'badge-secondary';
                        const statusText = device.is_active ? 'Active' : 'Inactive';
                        
                        $('#deviceList .list-group').append(`
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <a href="/packets/${device.ip}/">${device.ip}</a>
                                    <span class="badge ${statusClass} ml-2">${statusText}</span>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-warning ml-2 edit-device" data-id="${device.id}">Edit</button>
                                    <button class="btn btn-sm btn-danger ml-2 delete-device" data-id="${device.id}">Delete</button>
                                </div>
                            </li>
                        `);
                    });
                } else {
                    $('#deviceList .list-group').append(
                        '<li class="list-group-item text-center">No devices found.</li>'
                    );
                }
            })
           
    }

    // Load devices when page loads
    loadActiveDevices();

    // Scan button click handler
    $('#scanDevices').click(function() {
        $(this).prop('disabled', true).text('Scanning...');
        loadActiveDevices();
        setTimeout(() => {
            $(this).prop('disabled', false).text('Scan Devices');
        }, 2000);
    });

    // Edit device handler
    $(document).on('click', '.edit-device', function() {
        const deviceId = $(this).data('id');
        const listItem = $(this).closest('li');
        const deviceIp = listItem.find('a').text();
        const isActive = listItem.find('.badge').hasClass('badge-success');
        
        // Create a simple form for editing
        const editForm = `
            <div class="edit-form p-3">
                <div class="form-group">
                    <label>IP Address:</label>
                    <input type="text" class="form-control" id="edit-ip" value="${deviceIp}">
                </div>
                <div class="form-group">
                    <label>Status:</label>
                    <select class="form-control" id="edit-status">
                        <option value="true" ${isActive ? 'selected' : ''}>Active</option>
                        <option value="false" ${!isActive ? 'selected' : ''}>Inactive</option>
                    </select>
                </div>
                <button class="btn btn-primary save-edit" data-id="${deviceId}">Save</button>
                <button class="btn btn-secondary cancel-edit">Cancel</button>
            </div>
        `;
        
        // Replace the list item content with the form
        listItem.html(editForm);
    });

    // Save edit handler
    $(document).on('click', '.save-edit', function() {
        const deviceId = $(this).data('id');
        const newData = {
            ip_address: $('#edit-ip').val(),
            is_active: $('#edit-status').val() === 'true'
        };
        
        fetch(`/api/devices/${deviceId}/update/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(newData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                loadActiveDevices();  // Refresh the list
            } else {
                alert('Error updating device');
            }
        });
    });

    // Cancel edit handler
    $(document).on('click', '.cancel-edit', function() {
        loadActiveDevices();  // Refresh the list to cancel edit
    });

    // Delete device handler
    $(document).on('click', '.delete-device', function() {
        const deviceId = $(this).data('id');
        if (confirm('Are you sure you want to delete this device?')) {
            fetch(`/api/devices/${deviceId}/delete/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    loadActiveDevices();  // Refresh the list
                } else {
                    alert('Error deleting device');
                }
            });
        }
    });

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
